# Security Implementation

## Overview

The application now uses a secure API proxy layer that completely hides the backend implementation (Base44/Supabase) from the client. All API calls are encrypted and authenticated using secure tokens.

## Architecture

### Client Layer
- **Secure API Client** (`api/secureClient.ts`): Client-side API wrapper
- Uses encrypted tokens for authentication
- Automatic token caching and refresh
- Optimized for low and high bandwidth scenarios

### API Proxy Layer
- **API Routes** (`app/api/data/*`): Secure proxy endpoints
- Encrypts all communication
- Implements caching for performance
- Hides backend implementation details

### Encryption Layer
- **Crypto Library** (`lib/api-crypto.ts`): AES-256-CBC encryption
- HMAC-SHA256 token signing
- Secure token generation and verification

## Security Features

### 1. Encrypted Tokens
- **Algorithm**: AES-256-CBC encryption
- **Signing**: HMAC-SHA256
- **Expiration**: 1 hour (configurable)
- **Randomization**: Includes random bytes to prevent replay attacks

### 2. API Proxy
- All backend calls go through `/api/data/*` endpoints
- Backend URLs and keys are never exposed to the client
- Request/response encryption
- Token-based authentication

### 3. Performance Optimizations
- **Caching**: 10-second cache for GET requests
- **Token Caching**: Tokens cached for 1 hour
- **Request Timeouts**: 5-10 seconds for low bandwidth scenarios
- **Stale-While-Revalidate**: CDN caching headers

### 4. Low Bandwidth Support
- Request timeouts prevent hanging
- Cached responses reduce network calls
- Optimized payload sizes
- Graceful error handling

## Environment Variables

Add these to your `.env.local`:

```env
# API Encryption
API_ENCRYPTION_KEY=<generate-random-32-byte-hex>
API_SECRET=<generate-random-32-byte-hex>

# Backend API (hidden from client)
BACKEND_API_URL=https://app.base44.com/api/apps/...
BACKEND_API_KEY=your-backend-api-key
```

## Token Generation

Tokens are automatically generated by the API. The client requests a token from `/api/data/token` which:
1. Generates an encrypted token
2. Signs it with HMAC-SHA256
3. Includes expiration timestamp
4. Returns encrypted token to client

## Performance

### Caching Strategy
- **API Responses**: 10 seconds cache
- **Tokens**: 1 hour cache (with 5-minute refresh buffer)
- **CDN Headers**: `s-maxage=10, stale-while-revalidate=30`

### Request Optimization
- Automatic token refresh
- Parallel request handling
- Timeout protection
- Error retry logic

## Migration Notes

All components have been migrated from `supabaseApi` to `secureApi`:
- `app/admin/page.tsx`
- `app/home/page.tsx`
- `app/components/forms/SubmitListingForm.tsx`
- `app/components/help/SeekHelpDialog.tsx`

The old `supabaseApi` client is deprecated but kept for backward compatibility.

